name: test-github-actions-releases

on:
  push:
  workflow_dispatch:

jobs:
  test-github-actions-releases:
    runs-on: ubuntu-latest
    env:
      R_REMOTES_NO_ERRORS_FROM_WARNINGS: true
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
      R_KEEP_PKG_SOURCE: yes

    steps:
      - name: Checkout github-actions-repo
        uses: actions/checkout@v4
        with:
          repository: actions/runner-images
          path: runner-images

      - name: Git tags
        run: |
          cd runner-images
          git fetch --tags
          git fetch --prune --unshallow || true
          
      - name: Get latest release ubuntu
        id: get_release_ubuntu
        run: |
          RELEASES=$(curl -s https://api.github.com/repos/actions/runner-images/releases)
          RELEASE=$(echo "$RELEASES" | jq -r '.[] | select(.prerelease == false) | .tag_name' | sort -r | grep ubuntu22 |head -n1)
          echo "$RELEASE"
          echo "RELEASE_TAG_UBUNTU=$RELEASE" >> $GITHUB_OUTPUT

      - name: Get latest release macOS-12
        id: get_release_macos12
        run: |
          RELEASES=$(curl -s https://api.github.com/repos/actions/runner-images/releases)
          RELEASE=$(echo "$RELEASES" | jq -r '.[] | select(.prerelease == false) | .tag_name' | sort -r | grep macOS-12 |head -n1)
          echo "$RELEASE"
          echo "RELEASE_TAG_MACOS12=$RELEASE" >> $GITHUB_OUTPUT
      
      - name: Get latest release macos-13
        id: get_release_macos13
        run: |
          RELEASES=$(curl -s https://api.github.com/repos/actions/runner-images/releases)
          RELEASE=$(echo "$RELEASES" | jq -r '.[] | select(.prerelease == false) | .tag_name' | sort -r | grep macos-13$ |head -n1)
          echo "$RELEASE"
          echo "RELEASE_TAG_MACOS13=$RELEASE" >> $GITHUB_OUTPUT

      - name: Get latest release macos-14
        id: get_release_macos14
        run: |
          RELEASES=$(curl -s https://api.github.com/repos/actions/runner-images/releases)
          RELEASE=$(echo "$RELEASES" | jq -r '.[] | select(.prerelease == false) | .tag_name' | sort -r | grep macos-14$ |head -n1)
          echo "$RELEASE"
          echo "RELEASE_TAG_MACOS14=$RELEASE" >> $GITHUB_OUTPUT

      - name: Get latest release windows 2022
        id: get_release_windows
        run: |
          RELEASES=$(curl -s https://api.github.com/repos/actions/runner-images/releases)
          RELEASE=$(echo "$RELEASES" | jq -r '.[] | select(.prerelease == false) | .tag_name' | sort -r | grep win22 |head -n1)
          echo "$RELEASE"
          echo "RELEASE_TAG_WINDOWS=$RELEASE" >> $GITHUB_OUTPUT
